# yocto 사용해보기

What is?
리눅스 배포 자동화 도구

설치 패키지

python3
python3-distutils
xterm net-tools
chrpath diffstat g++ gawk groff
libncurses-dev
make gcc
vim tree git

`$ git clone -b dunfell git://git.yoctoproject.org/poky.git`


임베디드 리눅스 배포
CD(DVD) : BSP(Board Support Package)
-> distro for Acme board
-> distribute
-> install on Acme board

Yocto 구성요소
1. open embedded(oe_)
2. bitbake
    - 빌드 엔진
    - recipe
        - .bb
        - .bbappend
        - .bbclass
        - .conf
    -> 레시피 코드를 읽어들여 실행 작업(=task)(fetch, unpack, patch, configure, compile, link, insatll, pakage)
3. poky(basic distro)

관련 용어
- Append file
- Bitbake
- BSP
- Class
- Conf file
- Cress tool chain
- Image
- Layer
- Meta data
- OE(oe-core)(meta folder)
- Package
- Package Management System
- Poky
    - 참조 배포판
    - BitBake
    - oe-core
    - 기본 distro
    - 예제 BSP
- Recipe
- Task
- Upstream

오픈 소스 소프트웨어 빌드 절차 : Work-Flow

1. fetch( = download) : from Upstream
    'do_fetch'
    실패 시 Source Mirror 확인
2. Extract(unpack)
3. Patch
    `/poky/meta` `meta-poky` `meta-yocto-bsp`
4. Configure
5. Build
6. Install
7. Package



사용법
`~/poky/build/downloads` --> 페치한 압축 파일들
`~/poky/build/tmp`       --> 작업 디렉토리

`bitbake` : `bblayers.conf`  `local.conf`
`.bb`
`.bbappend`
`.bbclass`

메타 데이터 파일
`/poky/meta` `meta-poky` `meta-yocto-bsp` --> recipe가 들어있는 Layer file : meta data


`$ . oe-init-build-env`
`$ bitbake core-image-minimal` : 생성

`echo $BBPATH`


### 레이어 만들기
`/poky/build$ bitbake-layers create-layer {meta-xxx}` : 레이어 생성
`/poky/build$ bitbake-layers add-layer {meta-xxx}` : 레이어 추가

`meta-xxx/recipes-example/example/`로 가면 예시 파일을 볼 수 있다

```c
python do_display_banner(){
    bb.plain("************");
}
// 함수로 만들어진 작업 단위를 태스크라고 칭하며 do_{태스크 이름} 의 형태로 작성한다

addtask display_banner before do_build
// 태스크 추가 명령어
```


### bitbake 사용법
- `-h` : help
- `-b` : Out of dependencies
- `-k` : build fas possible
- `-c listtasks {core-image-minimal}` : task list up
- `-f` : force. Invalidation stamp
- `-C` : Invalidation stamp
- `-e` : environment list

> 실습 040200
### bitbake 메타데이터 문법
`#` : 주석


### 레시피를 사용하여 응용프로그램 다운로드
https://mirror.twds.com.tw/gnu/hello/


## 의존성
### 의존성 종류
#### task dependency
`.bb`
- `addtask display_banner before do_build`

#### package dependency
1. build dependency
- e.g. lib
2. execs dependency
- e.g. .so

- `DEPENDS` : 빌드 의존성
- `RDEPENDS` : 실행 의존성

### 프로비저닝
공표
- packagename
- version
- revision

#### 묵시적 프로비저닝
이름을 통해 PN과 PV를 유추

hello_1.0.bb
- PN : hello
- PV : 1.0

#### 명시적 프로비저닝
직접 명시하여 PN과 PV를 설정

hello.bb
- PN : hello_world
- PV : 2.1

#### 심볼릭 프로비저닝
Virtual 접두어를 사용


## 디버깅 도구
### 로깅
#### python
- `bb.plain(message)`

#### sh
- `bbplain message`

#### 로그 레벨 별 출력
`bitbake -D {target}`    : level 1
`bitbake -DD {target}`   : level 2
`bitbake -DDD {target}`  : level 3

### 태스크 실행
bitbake -listtask


### 의존성 그래프

`$ bitbake -g {target}`
`$ dot -Tpng pn-depends.dot -o pn-depends.png`

###  
`$ bitbake show-recipes`
`$ bitbake show-overlays`
`$ bitbkae show-appends`

## 코어 이미지 확장
### 루트파일 시스템
### build
`bblayers.conf`
`local.conf`
`templateconf.cfg`

`inherit`

### recipe를 이용한 확장
```bash
DESCRIPTION = ""
require recipes-core/images/core-image-base.bb
IMAGE_INSTALL += ""
IMAGE_FEATURES = ""
```


## 리눅스 시스템 구조

### 부트로더
부트로더 = “전원 ON → 진짜 프로그램(OS/펌웨어)을 실행시켜 주는 중간 관리자”
- 전원 켜자마자 OS는 바로 실행 불가
-> 최소한의 준비 작업이 필요

부트로더가 해주는 일
- 메모리 초기화
- 펌웨어 무결성 검사
- 펌웨어 업데이트 (UART, USB, CAN 등)
- 복구 모드 제공 (벽돌 방지)

#### 부트로더의 기능
- 로더
    - 시스템 초기화
    - 커널 적재
- 모니터

#### 종류
LILO
GRUB
SYSLINUX
U-Boot
systemd-boot
Barebox


#### 커널 서브 시스템

#### 동작 흐름
head.o
- check architecture
- Activate MMU
- Jump to `start_kernel()` @ main.c

start_kernel
- `rest_init()`
- `schedule()`
- `run init`

사용자 영역
init 1번 프로세스
lib

## 소프트웨어 패키지 레시피
Yocto 레시피 = “이 패키지를 이렇게 만들어라”라고 BitBake에게 알려주는 설명서

#### 양식
`{packagename}_{version}-{revision}.bb`
- BPN, PV, PR로 구성

### metadata
#### 서술 메타데이터
`$ bitbake -e {helloworld} | grep -w ^{S}`
- 변수 확인
- S
- B
- D
#### 패키지 관리자 메타데이터

#### 라이선스 메타데이터

#### 상속지시자/인클루드

#### 빌드 메타데이터

#### 패키지 메타데이터

#### 태스크 덮어쓰기

#### 변형

#### 실행 시간 메타데이터



### 형식화 지침

### 사용 방법
#### 생성
새로운 레이어를 만들어서 추가
- `bitbake-layers create-layer`
레시피는 BBFILES에 의해 자동 검색 가능
`BBFILES = `

#### do_fetch
upstream에서 소스 코드를 다운로드
#### do_unpack
압축 해제하고 위치를 특정
`$ bitbake -c fetch`
`$ bitbake -c unpack`
#### do_patch
압축 해제한 소스에 대해 패치를 적용

#### 라이선스 정보
`LICENSE`
`LIC_FILE_CHECKSUM`

`md5sum`

#### 소스 빌드 환경 별 환경 변수 제공


#### do_install


## Devtool

## 커널 레시피
### kbuild에 의한 커널 환경 설정 메커니즘
#### kbuild 사용
- `$ make menuconfig`
- `Kconfig`
- `.config`



---
## 임시 이름: 
### 요약:


### 키워드:
---
## 임시 이름: 
### 요약:


### 키워드:
---